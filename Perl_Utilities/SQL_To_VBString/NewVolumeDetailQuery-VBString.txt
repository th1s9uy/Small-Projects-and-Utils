query = "            SELECT " 
query = query & "                           MPBD.BUSINESS_DIVISION_CODE,   "
query = query & "                           INITCAP(MPBD.BUSINESS_DIVISION_DESCR)AS BusinessDivisionDescr,   "
query = query & "                          (MPBD.BUSINESS_DIVISION_CODE ||'/*'||INITCAP(MPBD.BUSINESS_DIVISION_DESCR))AS BusinessDivisionCodeDescr,   "
query = query & "                           M.REGION_CODE,   "
query = query & "                           M.REGION_DESCR,    "
query = query & "                           P.MINOR_LINE_CODE,   "
query = query & "                           INITCAP(P.MINOR_LINE_DESCR) AS MINOR_LINE_DESCR,     "
query = query & "                           IDS_MF.YEAR_DESCR,   "
query = query & "                           IDS_MF.MONTH_DESCR,   "
query = query & "                          SUM(IDS_MF.MF_Pounds_Shipped +   "
query = query & "                                 IDS_MF.IDS_Pounds_Shipped) "
query = query & "                                       AS TOTAL_POUNDS_SHIPPED,                  "
query = query & "                           SUM(IDS_MF.MF_Gross_Sales_Amount  "
query = query & "						       - IDS_MF.MF_Allow_Amount  "
query = query & "							   - IDS_MF.MF_Off_Invoice_Amount  "
query = query & "							   + IDS_MF.MF_Revenue_Adjustment  "
query = query & "							   + IDS_MF.IDS_Indirect_Sales_Amount)   "
query = query & "                                      AS NET_RECEIVABLE_DOLLAR              "
query = query & "                              FROM(   "
query = query & "                              /*Begin Sub query*/   "
query = query & "                        SELECT   "
query = query & "                         MPBD1.BUSINESS_DIVISION_CODE    "
query = query & "                        ,MPBD1.BUSINESS_DIVISION_DESCR   "
query = query & "                        ,MPBD1.RESTATED_MARKET_KEY   "
query = query & "                        ,MPBD1.RESTATED_PRODUCT_KEY   "
query = query & "                        ,WD.YEAR_DESCR   "
query = query & "                        ,WD.MONTH_DESCR   "
query = query & "                        ,WD.FISCAL_MONTH_NUMBER   "
query = query & "                        ,sum(MF.POUNDS_SHIPPED) AS MF_Pounds_Shipped   "
query = query & "                        /*,sum(MF.ADJ_POUNDS_SHIPPED) AS MF_Adjusted_Pounds_Shipped */  "
query = query & "                        ,sum(MF.GROSS_SALES_AMOUNT) AS MF_Gross_Sales_Amount   "
query = query & "                        ,sum(MF.ALLOW_AMOUNT) AS MF_Allow_Amount   "
query = query & "                        ,sum(mf.gross_sales_variance) AS MF_Revenue_Adjustment   "
query = query & "                        ,sum(MF.OFF_INVOICE_AMOUNT) AS MF_Off_Invoice_Amount   "
query = query & "                        ,0 AS IDS_Pounds_Shipped   "
query = query & "                        ,0 AS IDS_Indirect_Sales_Amount   "
query = query & "                        FROM  TDW_OWNER.RESTATED_MKT_PRD_BUS_DIV_DIM MPBD1   "
query = query & "                        ,TDW_OWNER.RESTATED_MARKET M1   "
query = query & "                        /*,TDW_OWNER.MONTH_DIM MD */  "
query = query & "                        ,TDW_OWNER.RESTATED_PRODUCT P1   "
query = query & "                        /*,TDW_OWNER.DAY_DIM D1 */  "
query = query & "                        /*,TDW_OWNER.MARGIN_FACT MF */  "
query = query & "                        ,tdw_owner.ta_margin_fact_view mf/*newly added*/  "
query = query & "                        ,tdw_owner.week_dim wd /*new added*/  "
query = query & "                        WHERE    "
query = query & "                            MF.RESTATED_MARKET_KEY = M1.RESTATED_MARKET_KEY    "
query = query & "                        AND MF.RESTATED_PRODUCT_KEY = P1.RESTATED_PRODUCT_KEY    "
query = query & "                        AND MF.RESTATED_MARKET_KEY = MPBD1.RESTATED_MARKET_KEY   "
query = query & "                        AND MF.RESTATED_PRODUCT_KEY = MPBD1.RESTATED_PRODUCT_KEY   "
query = query & "                        /*AND MF.INVOICE_DAY_KEY = D1.DAY_KEY  */  "
query = query & "                        /*AND D1.MONTH_ENDING_DATE = MD.MONTH_ENDING_DATE */  "
query = query & "                        AND To_DATE(mf.week_key,'YYYYMMDD')  = wd.week_ending_date /* newly added*/  "
query = query & "                        AND(MPBD1.BUSINESS_DIVISION_CODE IN ('F01', 'F03', 'F04', 'F08', 'F11', 'F12', 'F15'))    "
query = query & "                        AND (M1.SELLING_GROUP_CODE IN ('119000','125000','610000','800000','423000'))   "
query = query & "                        /*AND (MD.YEAR_DESCR IN(:p_Year))   */  "
query = query & "                        AND (wd.YEAR_DESCR IN (:p_Year)) /*newly added             */  "
query = query & "                        /*AND (MD.FISCAL_MONTH_NUMBER= (:p_Month))  */  "
query = query & "                        AND wd.FISCAL_MONTH_NUMBER <= :p_Month /*newly added   */  "
query = query & "                        AND (MPBD1.BUSINESS_DIVISION_CODE IN(:p_BusinessDivision))    "
query = query & "                        AND (M1.DIVISION_CODE IN(:p_SalesDivision))    "
query = query & "                        AND (M1.REGION_CODE IN(:p_SalesRegion))    "
query = query & "                        AND (M1.PRIMARY_BROKER_CODE IN(:p_PrimaryBroker))    "
query = query & "                        /*AND (M1.SECONDARY_BROKER_CODE IN(:p_SecondaryBroker))*/   "
query = query & "                        /*-AND (M1.BILL_TO_NUMBER IN(:p_BillTo))  AND (M1.SHIP_TO_NUMBER IN(:p_ShipTo))*/   "
query = query & "                        Group by   "
query = query & "                        MPBD1.BUSINESS_DIVISION_CODE    "
query = query & "                        ,MPBD1.BUSINESS_DIVISION_DESCR   "
query = query & "                        ,MPBD1.RESTATED_MARKET_KEY   "
query = query & "                        ,MPBD1.RESTATED_PRODUCT_KEY   "
query = query & "                        /*,MD.YEAR_DESCR */  "
query = query & "                        /*,MD.MONTH_DESCR  */  "
query = query & "                        /*,MD.FISCAL_MONTH_NUMBER */  "
query = query & "                        ,wd.year_descr /*newly added*/  "
query = query & "                        ,wd.month_descr /*newly added*/  "
query = query & "                        ,wd.FISCAL_MONTH_NUMBER /*newly added*/  "
query = query & "                        UNION    "
query = query & "                        SELECT  /*+ RULE */   "
query = query & "                         MPBD1.BUSINESS_DIVISION_CODE    "
query = query & "                        ,MPBD1.BUSINESS_DIVISION_DESCR   "
query = query & "                        ,MPBD1.RESTATED_MARKET_KEY   "
query = query & "                        ,MPBD1.RESTATED_PRODUCT_KEY   "
query = query & "                        ,MD.YEAR_DESCR   "
query = query & "                        ,MD.MONTH_DESCR   "
query = query & "                        ,MD.FISCAL_MONTH_NUMBER   "
query = query & "                        ,0 AS MF_Pounds_Shipped   "
query = query & "                        /*,0 AS MF_Adjusted_Pounds_Shipped */  "
query = query & "                        ,0 AS MF_Gross_Sales_Amount   "
query = query & "                        ,0 AS MF_Allow_Amount   "
query = query & "                        ,0 AS MF_Revenue_Adjustment   "
query = query & "                        ,0 AS MF_Off_Invoice_Amount   "
query = query & "                        ,sum(IDS.POUNDS_SHIPPED) AS IDS_Pounds_Shipped   "
query = query & "                        ,sum(IDS.INDIRECT_SALES_AMOUNT) AS IDS_Indirect_Sales_Amount   "
query = query & "                        FROM  TDW_OWNER.RESTATED_MKT_PRD_BUS_DIV_DIM MPBD1   "
query = query & "                        ,TDW_OWNER.RESTATED_MARKET M1   "
query = query & "                        ,TDW_OWNER.MONTH_DIM MD   "
query = query & "                        ,TDW_OWNER.RESTATED_PRODUCT P1   "
query = query & "                        ,TDW_OWNER.INDIRECT_SALES IDS   "
query = query & "                        ,TDW_OWNER.WEEK_DIM W    "
query = query & "                        WHERE    "
query = query & "                            IDS.RESTATED_MARKET_KEY = M1.RESTATED_MARKET_KEY   "
query = query & "                        AND IDS.RESTATED_PRODUCT_KEY = P1.RESTATED_PRODUCT_KEY   "
query = query & "                        AND IDS.RESTATED_MARKET_KEY = MPBD1.RESTATED_MARKET_KEY   "
query = query & "                        AND IDS.RESTATED_PRODUCT_KEY = MPBD1.RESTATED_PRODUCT_KEY   "
query = query & "                        AND IDS.WEEK_KEY = W.WEEK_KEY    "
query = query & "                        AND W.MONTH_ENDING_DATE = MD.MONTH_ENDING_DATE   "
query = query & "                        AND(MPBD1.BUSINESS_DIVISION_CODE IN ('F01', 'F03', 'F04', 'F08', 'F11', 'F12', 'F15'))    "
query = query & "                        AND (M1.SELLING_GROUP_CODE IN ('119000','125000','610000','800000','423000'))   "
query = query & "                        AND (MD.YEAR_DESCR IN(:p_Year))                  "
query = query & "                        AND (MD.FISCAL_MONTH_NUMBER= (:p_Month))    "
query = query & "                        AND (MPBD1.BUSINESS_DIVISION_CODE IN(:p_BusinessDivision))    "
query = query & "                        AND (M1.DIVISION_CODE IN(:p_SalesDivision))    "
query = query & "                        AND (M1.REGION_CODE IN(:p_SalesRegion))    "
query = query & "                        AND (M1.PRIMARY_BROKER_CODE IN(:p_PrimaryBroker))    "
query = query & "                        /*AND (M1.SECONDARY_BROKER_CODE IN(:p_SecondaryBroker))*/   "
query = query & "                        /*AND (M1.BILL_TO_NUMBER IN(:p_BillTo)) AND (M1.SHIP_TO_NUMBER IN(:p_ShipTo)) */   "
query = query & "                        group by   "
query = query & "                        MPBD1.BUSINESS_DIVISION_CODE    "
query = query & "                        ,MPBD1.BUSINESS_DIVISION_DESCR   "
query = query & "                        ,MPBD1.RESTATED_MARKET_KEY   "
query = query & "                        ,MPBD1.RESTATED_PRODUCT_KEY   "
query = query & "                        ,MD.YEAR_DESCR   "
query = query & "                        ,MD.MONTH_DESCR   "
query = query & "                        ,MD.FISCAL_MONTH_NUMBER   "
query = query & "                           )/*end sub query*/   "
query = query & "                         IDS_MF   "
query = query & "                        ,TDW_OWNER.RESTATED_MKT_PRD_BUS_DIV_DIM MPBD   "
query = query & "                        ,TDW_OWNER.RESTATED_MARKET M   "
query = query & "                        ,TDW_OWNER.RESTATED_PRODUCT P   "
query = query & "                        WHERE    "
query = query & "                            IDS_MF.RESTATED_MARKET_KEY  =  MPBD.RESTATED_MARKET_KEY   "
query = query & "                        AND IDS_MF.RESTATED_PRODUCT_KEY =  MPBD.RESTATED_PRODUCT_KEY   "
query = query & "                        AND IDS_MF.RESTATED_MARKET_KEY = M.RESTATED_MARKET_KEY   "
query = query & "                        AND IDS_MF.RESTATED_PRODUCT_KEY = P.RESTATED_PRODUCT_KEY   "
query = query & "                        AND(MPBD.BUSINESS_DIVISION_CODE IN ('F01', 'F03', 'F04', 'F08', 'F11', 'F12', 'F15'))    "
query = query & "                        AND (M.SELLING_GROUP_CODE IN ('119000','125000','610000','800000','423000'))   "
query = query & "                        AND (IDS_MF.YEAR_DESCR IN(:p_Year))                  "
query = query & "                        AND (IDS_MF.FISCAL_MONTH_NUMBER = (:p_Month))    "
query = query & "                        AND (MPBD.BUSINESS_DIVISION_CODE IN(:p_BusinessDivision))    "
query = query & "                        AND (M.DIVISION_CODE IN(:p_SalesDivision))    "
query = query & "                        AND (M.REGION_CODE IN(:p_SalesRegion))    "
query = query & "                        AND (M.PRIMARY_BROKER_CODE IN(:p_PrimaryBroker))    "
query = query & "                        /*AND (M.SECONDARY_BROKER_CODE IN(:p_SecondaryBroker))*/   "
query = query & "                        /*-AND (M.BILL_TO_NUMBER IN(:p_BillTo)) AND (M.SHIP_TO_NUMBER IN(:p_ShipTo)) */   "
query = query & "                            "
query = query & "                         GROUP BY   "
query = query & "                           MPBD.BUSINESS_DIVISION_CODE,   "
query = query & "                           INITCAP(MPBD.BUSINESS_DIVISION_DESCR),   "
query = query & "                           M.REGION_CODE,   "
query = query & "                           M.REGION_DESCR,   "
query = query & "                           P.MINOR_LINE_CODE,   "
query = query & "                           INITCAP(P.MINOR_LINE_DESCR),     "
query = query & "                           IDS_MF.YEAR_DESCR,   "
query = query & "                           IDS_MF.MONTH_DESCR   "
query = query & "                           ORDER BY BusinessDivisionDescr,MINOR_LINE_CODE "